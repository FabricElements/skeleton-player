<script>
  const SkeletonPlayerBehavior = superclass => class extends superclass {
    constructor() {
      super();
    }

    connectedCallback() {
      super.connectedCallback();
      this.addEventListener('play', e => this.play(e));
      this.addEventListener('pause', e => this.pause(e));
      this.addEventListener('change-progress', e => this.changeProgress(e));
    }

    static get properties() {
      return {
        type: {
          type: String,
          value: null
        },
        src: {
          type: String,
          value: null
        },
        autoplay: {
          type: Boolean,
          value: false
        },
        controls: {
          type: Boolean,
          value: false
        },
        preload: {
          type: String,
          value: "none"
        },
        loop: {
          type: Boolean,
          value: false
        },
        muted: {
          type: Boolean,
          value: false
        },
        playing: {
          type: Boolean,
          value: false
        },
        paused: {
          type: Boolean,
          value: false
        },
        ended: {
          type: Boolean,
          value: false
        },
        timeOffset: {
          type: Number,
          value: 0
        },
        percentagePlayed: {
          type: Number,
          value: 0
        },
        duration: {
          type: Number,
          value: 0
        },
        disabled: {
          type: Boolean,
          value: false
        },
        error: {
          type: Boolean,
          value: false
        },
        events: {
          type: Array,
          value: null,
          observer: "_eventsObserver",
        },
        finalEvents: {
          type: Object,
          value: null
        },
        loaded: {
          type: Boolean,
          value: false
        },
        progress: {
          type: Number,
          value: 0
        },
      };
    }

    _resetProperties() {
      this.disabled = false;
      this.error = false;
      this.paused = false;
      this.ended = false;
      this.playing = false;
    }

    _loadedMetadata() {
      this.loaded = true;
      const player = this.shadowRoot.querySelector("#player");
      this.duration = player.duration;
    }

    _error() {
      this._resetProperties();
      this.error = true;
      this.disabled = true;
    }

    play() {
      this.shadowRoot.querySelector("#player").play();
    }

    pause() {
      this.shadowRoot.querySelector("#player").pause();
    }

    _playing() {
      this._resetProperties();
      const player = this.shadowRoot.querySelector("#player");
      this.played = player.played;
      this.playing = true;
      this._setTimeLeft();
//        this.fire("skeleton-player-state-change", "playing");
    }

    _ended() {
      this._resetProperties();
      this.ended = true;
      this.fire("skeleton-player-state-change", "ended");
    }

    _progress() {
      const player = this.shadowRoot.querySelector("#player");
      this.progress = (player.currentTime / this.duration) * 100;
      this._checkTimeEvents(player.currentTime);
    }

    _paused() {
      this._resetProperties();
      this.paused = true;
//        this.fire("skeleton-player-state-change", "paused");
    }

    _setBase() {
      this.totalTime = this.duration;
    }

//
    _setTimeLeft() {
      const player = this.shadowRoot.querySelector("#player");
    }

    _updatePlayPosition() {

    }

    changeProgress(e) {
      const player = this.shadowRoot.querySelector("#player");
      player.currentTime = this.duration * e.detail;
//        if (!this.playing) this.fire('play');
      this._resetEventsBeforeNewTime();
    }

    _resetEventsBeforeNewTime() {
      const player = this.shadowRoot.querySelector("#player");
      let time = player.currentTime;
      time = Math.floor(time);

      if (!this.finalEvents) return;
      for (let event in this.finalEvents) {
        if (!event) return;
        if (this.finalEvents[event].time >= time) this.finalEvents[event]["fired"] = false;
      }
    }

    _eventsObserver(events) {
      if (!events) return;
      let baseEvents = [];
      for (let event in events) {
        if (!event) return;
        let eventBase = {
          event: events[event],
          time: event,
          fired: false
        };
        baseEvents.push(eventBase);
      }
      if (baseEvents[0]) this.finalEvents = baseEvents;
    }

    _checkTimeEvents(time) {
      if (!this.finalEvents) return;
      time = Math.floor(time);
      const events = this.finalEvents;

      for (let event in events) {
        if (!events[event]["fired"] && time >= events[event]["time"]) {
          this.finalEvents[event]["fired"] = true;
//            this.fire("skeleton-player-event", events[event]['event']);
        }
      }
    }

  };
</script>
