<link rel="import" href="../../polymer/polymer.html">

<!--
`skeleton-player-behavior`
Skeleton player behavior

@demo demo/index.html
-->

<script>
  'use strict';
  window.Fabric = window.Fabric || {};

  /**
   Use `Polymer.SkeletonPlayerBehavior` to implement an element that can be hidden or shown, and displays
   on top of other content. It includes an optional backdrop, and can be used to implement a variety
   of UI controls including dialogs and drop downs. Multiple overlays may be displayed at once.
   See the [demo source code](https://github.com/PolymerElements/iron-overlay-behavior/blob/master/demo/simple-overlay.html)
   for an example.
   @demo demo/index.html
   @polymerBehavior Fabric.SkeletonPlayerBehavior
   */
  Fabric.SkeletonPlayerBehavior = {
    properties: {
      src: {
        type: String,
        value: null
      },
      autoplay: {
        type: Boolean,
        value: false
      },
      controls: {
        type: Boolean,
        value: false
      },
      preload: {
        type: String,
        value: "none"
      },
      loop: {
        type: Boolean,
        value: false
      },
      muted: {
        type: Boolean,
        value: false
      },
      playing: {
        type: Boolean,
        value: false
      },
      paused: {
        type: Boolean,
        value: false
      },
      ended: {
        type: Boolean,
        value: false
      },
      timeOffset: {
        type: Number,
        value: 0
      },
      percentagePlayed: {
        type: Number,
        value: 0
      },
      duration: {
        type: Number,
        value: 0
      },
      disabled: {
        type: Boolean,
        value: true
      },
      error: {
        type: Boolean,
        value: false
      },
      events: {
        type: Array,
        value: null,
        observer: "_eventsObserver",
      },
      finalEvents: {
        type: Object,
        value: null
      }
    },
    listeners: {
      'play': "play",
      'pause': "pause",
      'change-progress': "changeProgress"
    },
    attached: function () {

    },
    _loadedMetadata: function () {
      const player = this.$$("#player");
      this.duration = player.duration;
      this.disabled = false;
      this.error = false;
    },
    _error: function () {
      this.error = true;
      this.disabled = true;
    },
    play: function () {
      this.$$("#player").play();
    },
    pause: function () {
      this.$$("#player").pause();
    },
    _playing: function () {
      this.playing = true;
      this.paused = false;
      this.ended = false;
      this.error = false;
      const player = this.$$("#player");
      this.played = player.played;
      this._setTimeLeft();
      this.fire("skeleton-player-state-change", "playing");
    },
    _ended: function () {
      this.playing = false;
      this.paused = false;
      this.ended = true;
      this.fire("skeleton-player-state-change", "ended");
    },
    _progress: function () {
      const player = this.$$("#player");
      this.progress = (player.currentTime / this.duration) * 100;
      this._checkTimeEvents(player.currentTime);
    },
    _paused: function () {
      this.playing = false;
      this.ended = false;
      this.paused = true;
      this.fire("skeleton-player-state-change", "paused");
    },
    _setBase: function () {
      this.totalTime = this.duration;
    },
    _setTimeLeft: function () {
      const player = this.$$("#player");
    },
    _updatePlayPosition: function () {

    },
    changeProgress: function (e) {
      const player = this.$$("#player");
      player.currentTime = this.duration * e.detail;
      if (!this.playing) this.fire('play');
      this._resetAllBeforeTime();
    },
    _resetAllBeforeTime: function () {
      const player = this.$$("#player");
      let time = player.currentTime;
      time = Math.floor(time);
      const events = this.events;

      if (!events) return;
      let baseEvents = [];
      for (let event in events) {
        if (!event) return;
        let eventBase = {
          event: events[event],
          time: event,
          fired: false
        };
        if (time <= event) {
          eventBase["fired"] = true;
        }
        baseEvents.push(eventBase);
      }
      if (baseEvents[0]) this.finalEvents = baseEvents;
    },
    _eventsObserver: function (events) {
      if (!events) return;
      let baseEvents = [];
      for (let event in events) {
        if (!event) return;
        let eventBase = {
          event: events[event],
          time: event,
          fired: false
        };
        baseEvents.push(eventBase);
      }
      if (baseEvents[0]) this.finalEvents = baseEvents;
    },
    _checkTimeEvents: function (time) {
      if (!this.finalEvents) return;
      time = Math.floor(time);
      const events = this.finalEvents;

      for (let event in events) {
        if (!events[event]["fired"] && time >= events[event]["time"]) {
          this.finalEvents[event]["fired"] = true;
          this.fire("skeleton-player-event", events[event]['event']);
          console.log("fired: " + events[event]['event']);
          break;
        }
      }
    }
  };
</script>
