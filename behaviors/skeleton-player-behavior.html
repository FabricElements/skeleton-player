<script>
  const SkeletonPlayerBehavior = superclass => class extends superclass {
    constructor() {
      super();
    }

    connectedCallback() {
      super.connectedCallback();

      this._actionListeners();
      this._playerListeners();
      // Listen for change event on the slider
      this.addEventListener('change', e => this.changeProgress(e));
    }

    static get properties() {
      return {
        type: {
          type: String,
          value: null
        },
        src: {
          type: String,
          value: null
        },
        autoplay: {
          type: Boolean,
          value: false
        },
        controls: {
          type: Boolean,
          value: false
        },
        preload: {
          type: String,
          value: "none"
        },
        loop: {
          type: Boolean,
          value: false
        },
        muted: {
          type: Boolean,
          value: false
        },
        playing: {
          type: Boolean,
          value: false
        },
        paused: {
          type: Boolean,
          value: false
        },
        ended: {
          type: Boolean,
          value: false
        },
        timeOffset: {
          type: Number,
          value: 0
        },
        percentagePlayed: {
          type: Number,
          value: 0
        },
        duration: {
          type: Number,
          value: 0
        },
        disabled: {
          type: Boolean,
          value: false
        },
        error: {
          type: Boolean,
          value: false
        },
        events: {
          type: Array,
          value: null,
          observer: "_eventsObserver",
        },
        finalEvents: {
          type: Object,
          value: null
        },
        loaded: {
          type: Boolean,
          value: false
        },
        progress: {
          type: Number,
          value: 0,
          reflectToAttribute: true
        },
        secondaryProgress: {
          type: Number,
          value: 0,
          reflectToAttribute: true
        },
        immediateValue: {
          type: Number,
          value: 0,
          reflectToAttribute: true
        },
        icon: {
          type: String,
          value: "player:loop",
          observer: "_iconObserver"
        }
      };
    }

    _actionListeners() {
      const action = this.shadowRoot.querySelector("#action");
      if (!action) return;
      action.addEventListener('tap', e => this.togglePlay(e));
    }

    _playerListeners() {
      const player = this.shadowRoot.querySelector("#player");
      if (!player) return;
      player.addEventListener('loadedmetadata', e => this._loadedMetadata(e));
      player.addEventListener('play', e => this._playing(e));
      player.addEventListener('pause', e => this._paused(e));
      player.addEventListener('timeupdate', e => this._progress(e));
      player.addEventListener('error', e => this._error(e));
      player.addEventListener('ended', e => this._ended(e));
    }

    _resetProperties() {
      this.disabled = false;
      this.error = false;
      this.paused = false;
      this.ended = false;
      this.playing = false;
    }

    _loadedMetadata() {
      this.loaded = true;
      const player = this.shadowRoot.querySelector("#player");
      this.duration = player.duration;

      this.icon = "player:play-arrow";
    }

    _error() {
      this._resetProperties();
      this.error = true;
      this.disabled = true;
    }

    togglePlay() {
      const player = this.shadowRoot.querySelector("#player");
      if (this.playing) this.pause();
      if (this.paused) this.play();
      if (this.ended) this.play();
    }

    play() {
      this.shadowRoot.querySelector("#player").play();
    }

    pause() {
      this.shadowRoot.querySelector("#player").pause();
    }

    _playing() {
      this._resetProperties();
      const player = this.shadowRoot.querySelector("#player");
      this.played = player.played;
      this.playing = true;
      this._setTimeLeft();
//        this.fire("skeleton-player-state-change", "playing");
      this.icon = "player:pause";
    }

    _ended() {
      this._resetProperties();
      this.ended = true;
//      this.fire("skeleton-player-state-change", "ended");
      this.icon = "player:replay";

    }

    _progress() {
      const player = this.shadowRoot.querySelector("#player");
      this.progress = (player.currentTime / this.duration) * 100;
      this._checkTimeEvents(player.currentTime);
    }

    _paused() {
      this._resetProperties();
      this.paused = true;
      this.icon = "player:play-arrow";
//        this.fire("skeleton-player-state-change", "paused");
    }

    _setBase() {
      this.totalTime = this.duration;
    }

//
    _setTimeLeft() {
      const player = this.shadowRoot.querySelector("#player");
    }

    _updatePlayPosition() {

    }

    changeProgress() {
      let position = this.immediateValue / 100;
      const player = this.shadowRoot.querySelector("#player");
      player.currentTime = this.duration * position;
//        if (!this.playing) this.fire('play');
      this._resetEventsBeforeNewTime();
    }

    _resetEventsBeforeNewTime() {
      const player = this.shadowRoot.querySelector("#player");
      let time = player.currentTime;
      time = Math.floor(time);

      if (!this.finalEvents) return;
      for (let event in this.finalEvents) {
        if (!event) return;
        if (this.finalEvents[event].time >= time) this.finalEvents[event]["fired"] = false;
      }
    }

    _eventsObserver(events) {
      if (!events) return;
      let baseEvents = [];
      for (let event in events) {
        if (!event) return;
        let eventBase = {
          event: events[event],
          time: event,
          fired: false
        };
        baseEvents.push(eventBase);
      }
      if (baseEvents[0]) this.finalEvents = baseEvents;
    }

    _checkTimeEvents(time) {
      if (!this.finalEvents) return;
      time = Math.floor(time);
      const events = this.finalEvents;

      for (let event in events) {
        if (!events[event]["fired"] && time >= events[event]["time"]) {
          this.finalEvents[event]["fired"] = true;
//            this.fire("skeleton-player-event", events[event]['event']);
        }
      }
    }

    _iconObserver(icon) {
      const action = this.shadowRoot.querySelector("#action");
      if (!action) return;
      action.icon = icon;
    }

  };
</script>
